%% Reads in two flat files and generates the boxplot comparing
% simulation data against the GMPEs. Mostly unmodified version
% of the script from Ronnie Kamai

%close all
%clc

ymin = 0.0003;
ymax = 2000*ymin;

% Name = ['-gmpe' num2str(Mag*10) num2str(Dist) ];
Sims = csvread(SimsFile);
NGAnum = csvread(GMPEFile);

T = [0.010,0.020,0.029,0.04,0.05,0.06,0.075,0.1,0.15,0.2,0.26,0.3,0.4,0.5,...
      0.6,0.75,1,1.5,2,3,4,5,6,7.5,10];

%Tcr = [0.01, 0.02, 0.03, 0.05, 0.075, 0.1, 0.15, 0.2, 0.25, 0.3, 0.4,...
%	0.5, 0.75, 1, 1.5, 2, 3, 4, 5, 10];

Tacpt = [0.01, 0.02, 0.03, 0.05, 0.075, 0.1, 0.15, 0.2, 0.25, 0.3, 0.4,...
	  0.5, 0.75, 1, 1.5, 2, 3];

%M62ssAvg = [0.103510707, 0.105260707, 0.111767005, 0.130828596,...
%	     0.168527513, 0.197742401, 0.229844714, 0.226726281,...
%	     0.20592189, 0.184598449, 0.149515001, 0.119902721,...
%	     0.075762555, 0.054046078, 0.031694796, 0.020141424,...
%	     0.010450695, 0.006320955, 0.004227879, 0.001003203];

% Acceptance rules for existing GMPE scenarios
% NGA-WEST1
nga1.M55rvLo20 = [0.0436221, 0.04462166, 0.04940387, 0.06279549,...
		   0.08096491, 0.09132741, 0.09393127, 0.08478165,...
		   0.07334698, 0.06364087, 0.04750753, 0.03639194,...
		   0.02063671, 0.01321022, 0.00649865, 0.00383689,...
		   0.00178624];
nga1.M55rvHi20 = [0.11322152, 0.1158159, 0.12822815, 0.16298622,...
		   0.21014509, 0.23704106, 0.2437994, 0.22005147,...
		   0.19037269, 0.16518042, 0.12330618, 0.09445558,...
		   0.05356274, 0.03428723, 0.0168673, 0.00995868,...
		   0.0046362];
nga1.M55rvLo50 = [0.01214008, 0.01237123, 0.01356571, 0.01702426,...
		   0.02166736, 0.02447316, 0.02579139, 0.0237992,...
		   0.02115549, 0.01878241, 0.01443256, 0.01122829,...
		   0.00657776, 0.00422454, 0.00213321, 0.00126461,...
		   0.0005884];
nga1.M55rvHi50 = [0.03233765, 0.03295336, 0.03613512, 0.04534767,...
		   0.05771555, 0.06518939, 0.06870077, 0.06339414,...
		   0.05635208, 0.05003088, 0.03844414, 0.02990891,...
		   0.01752124, 0.01125295, 0.00568225, 0.00336855,...
		   0.00156734];
nga1.M62ssLo20 = [0.06728196, 0.06841946, 0.072648554, 0.085038587,...
		   0.109542884, 0.12853256, 0.149399064, 0.147372083,...
		   0.133849228, 0.119988992, 0.097184751, 0.077936768,...
		   0.049245661, 0.035129951, 0.020601618, 0.013091926,...
		   0.006792951];
nga1.M62ssHi20 = [0.14491499, 0.14736499, 0.156473808, 0.183160034,...
		   0.235938518, 0.276839361, 0.3217826, 0.317416794,...
		   0.288290646, 0.258437829, 0.209321002, 0.167863809,...
		   0.106067577, 0.075664509, 0.044372715, 0.028197994,...
		   0.014630972];
nga1.M62ssLo50 = [0.02413404, 0.02448662, 0.02567124, 0.02928488,...
		   0.03713192, 0.04312212, 0.05143032, 0.05321518,...
		   0.05005904, 0.04628924, 0.0382897, 0.0312259,...
		   0.02031178, 0.01469734, 0.00880718, 0.0056608,...
		   0.00293166];
nga1.M62ssHi50 = [0.0553896, 0.0561988, 0.0589176, 0.0672112,...
		   0.0852208, 0.0989688, 0.1180368, 0.1221332,...
		   0.1148896, 0.1062376, 0.087878, 0.071666,...
		   0.0466172, 0.0337316, 0.0202132, 0.012992,...
		   0.0067284];
nga1.M66ssLo20 = [0.0790686, 0.0802334, 0.084877, 0.0980707,...
		   0.1263652, 0.1487317, 0.1757457, 0.1798329,...
		   0.1671254, 0.1525498, 0.1290159, 0.1065766,...
		   0.0711464, 0.0529425, 0.0329342, 0.0220168,...
		   0.0122733];
nga1.M66ssHi20 = [0.1946304, 0.1974976, 0.208928, 0.2414048,...
		   0.3110528, 0.3661088, 0.4326048, 0.4426656,...
		   0.4113856, 0.3755072, 0.3175776, 0.2623424,...
		   0.1751296, 0.13032, 0.0810688, 0.0541952,...
		   0.0302112];
nga1.M66ssLo50 = [0.0297132, 0.0301008, 0.0314532, 0.0354804,...
		   0.04479, 0.0520152, 0.0627456, 0.0667836,...
		   0.0639756, 0.0600852, 0.0519228, 0.0435852,...
		   0.0299028, 0.0225792, 0.0143736, 0.009738,...
		   0.0054036];
nga1.M66ssHi50 = [0.08121608, 0.08227552, 0.08597208, 0.09697976,...
		   0.122426, 0.14217488, 0.17150464, 0.18254184,...
		   0.17486664, 0.16423288, 0.14192232, 0.11913288,...
		   0.08173432, 0.06171648, 0.03928784, 0.0266172,...
		   0.01476984];
nga1.M66rvLo20 = [0.0790066, 0.08016352, 0.08480732, 0.09775168,...
		   0.12570004, 0.1483164, 0.17609736, 0.18121484,...
		   0.16972872, 0.15629456, 0.13195708, 0.1094796,...
		   0.07360516, 0.05386436, 0.03191636, 0.0208382,...
		   0.01131996];
nga1.M66rvHi20 = [0.2115338, 0.21463136, 0.22706476, 0.26172224,...
		   0.33655172, 0.3971052, 0.47148648, 0.48518812,...
		   0.45443496, 0.41846608, 0.35330444, 0.2931228,...
		   0.19707188, 0.14421748, 0.08545348, 0.0557926,...
		   0.03030828];
nga1.M66rvLo50 = [0.03178267, 0.03217359, 0.033642323, 0.037721806,...
		   0.047259278, 0.054916372, 0.065808374, 0.070046763,...
		   0.067213816, 0.063205181, 0.053938841, 0.045159798,...
		   0.030807022, 0.022667605, 0.013586382, 0.008941526,...
		   0.004847463];
nga1.M66rvHi50 = [0.087128354, 0.088200014, 0.092226369, 0.103409777,...
		   0.129555606, 0.150546607, 0.180405716, 0.192024747,...
		   0.184258565, 0.173269374, 0.147866822, 0.123800136,...
		   0.084453733, 0.062140504, 0.037245426, 0.024512114,...
		   0.013288734];
nga1.labels = {'AS08','BA08','CB08','CY08','Mean of 4 NGA Models','Acceptance Criteria'};
nga1.acptThin = [];

% NGA-WEST2
nga2.M55rvLo20 = [0.043162828, 0.043986244, 0.050532404, 0.066308951,...
		   0.082850287, 0.090492273, 0.093229471, 0.088219197,...
		   0.07690558, 0.066913585, 0.049811164, 0.038094685,...
		   0.021626464, 0.013399224, 0.006223801, 0.003481884,...
		   0.001590148, 0.000979361, 0.000606029, 0.000222181,...
		   0.00010707];
nga2.M55rvHi20 = [0.101461388, 0.104853367, 0.123067534, 0.162986215,...
		   0.20535873, 0.221988581, 0.227886312, 0.199684117,...
		   0.171597973, 0.15382306, 0.110439407, 0.082566413,...
		   0.048377614, 0.030035889, 0.014174531, 0.008401558,...
		   0.003936088, 0.002267193, 0.001518127, 0.000640095,...
		   0.000353764];
nga2.M55rvLo50 = [0.011874366, 0.012092877, 0.013686828, 0.01803045,...
		   0.022654288, 0.025115416, 0.027241209, 0.025956576,...
		   0.023337165, 0.020780156, 0.015878191, 0.012320678,...
		   0.007248839, 0.004645067, 0.002234405, 0.001259298,...
		   0.000578201, 0.000351471, 0.000203256, 7.47E-05,...
		   3.61E-05];
nga2.M55rvHi50 = [0.029726643, 0.030466799, 0.035226905, 0.045347672,...
		   0.05659596, 0.062552874, 0.066022908, 0.059792354,...
		   0.053539767, 0.049596244, 0.036182394, 0.027296789,...
		   0.016582087, 0.010136058, 0.004879038, 0.002899413,...
		   0.001356603, 0.000813832, 0.000560425, 0.000265524,...
		   0.000143461];
nga2.M62ssLo20 = [0.068466531, 0.069695186, 0.076408093, 0.097422245,...
		   0.123814297, 0.136956225, 0.146243099, 0.138883495,...
		   0.125917282, 0.115074816, 0.093146032, 0.075465575,...
		   0.047547496, 0.033686379, 0.019135667, 0.012666283,...
		   0.007019788, 0.00412385 0.002531575, 0.001038643,...
		   0.000540379];
nga2.M62ssHi20 = [0.142504114, 0.145061397, 0.159033435, 0.210536846,...
		   0.261667301, 0.295110986, 0.323027865, 0.30742257,...
		   0.27493888, 0.243420355, 0.193871262, 0.157071708,...
		   0.100027172, 0.070113785, 0.039828384, 0.026363208,...
		   0.01461077, 0.009514016, 0.006874933, 0.003753873,...
		   0.002164308];
nga2.M62ssLo50 = [0.02137448, 0.021959453, 0.024099659, 0.031448649,...
		   0.040144247, 0.043917118, 0.048246515, 0.045530733,...
		   0.041939743, 0.039251989, 0.032923606, 0.027287471,...
		   0.018056208, 0.012726296, 0.007399963, 0.004918294,...
		   0.002716006, 0.00152508, 0.00093839, 0.000385732,...
		   0.000200894];
nga2.M62ssHi50 = [0.048745761, 0.049404324, 0.053607771, 0.067996794,...
		   0.085744903, 0.096611288, 0.109675825, 0.110567163,...
		   0.101388253, 0.090808185, 0.07241828, 0.058417202,...
		   0.038183052, 0.026682366, 0.015402054, 0.010236785,...
		   0.005674808, 0.003772374, 0.002794809, 0.00161524,...
		   0.000907223];
nga2.M66ssLo20 = [0.085417391, 0.086968792, 0.094320954, 0.117282459,...
		   0.152663489, 0.172353817, 0.188287767, 0.179195223,...
		   0.161293332, 0.143989459, 0.117702522, 0.097375597,...
		   0.064089178, 0.046454371, 0.028139301, 0.019587618,...
		   0.011989636, 0.007364112, 0.004795379, 0.002143994,...
		   0.001177935];
nga2.M66ssHi20 = [0.179247367, 0.18480203, 0.215915347, 0.292453367,...
		   0.356440194, 0.375056915, 0.391896317, 0.372971379,...
		   0.335710939, 0.299695194, 0.244982378, 0.202674547,...
		   0.133393226, 0.096688686, 0.058568268, 0.040769061,...
		   0.025160942, 0.01757914, 0.014688678, 0.008873136,...
		   0.005018356];
nga2.M66ssLo50 = [0.030572971, 0.031321765, 0.034464839, 0.043768108,...
		   0.054836348, 0.061081236, 0.067142045, 0.065019697,...
		   0.060024542, 0.054796469, 0.045702084, 0.038262082,...
		   0.025924541, 0.018722731, 0.011607744, 0.008113298,...
		   0.004697369, 0.002904508, 0.001895507, 0.000848924,...
		   0.000466798];
nga2.M66ssHi50 = [0.06661183, 0.068101077, 0.078444572, 0.103073492,...
		   0.122849466, 0.129733734, 0.13974737, 0.135329981,...
		   0.124933219, 0.11405167, 0.0951229, 0.079637511,...
		   0.053958536, 0.038968912, 0.024159999, 0.016886766,...
		   0.010399168, 0.007978404, 0.006734335, 0.004488779,...
		   0.002598649];
nga2.M66rvLo20 = [0.091912809, 0.093697767, 0.103905415, 0.132085813,...
		   0.169327928, 0.190813845, 0.209418048, 0.199794261,...
		   0.180877286, 0.162285484, 0.13190601, 0.108449534,...
		   0.070777948, 0.050935201, 0.030429577, 0.020755248,...
		   0.012435454, 0.007913061, 0.005022391, 0.002186587,...
		   0.001190133];
nga2.M66rvHi20 = [0.194889368, 0.200576566, 0.234480754, 0.312298198,...
		   0.382137301, 0.406009288, 0.435876229, 0.415845578,...
		   0.376472372, 0.337775973, 0.274545078, 0.225723496,...
		   0.147315025, 0.106014948, 0.063335178, 0.04319933,...
		   0.025882768, 0.01757914, 0.014688678, 0.008873136,...
		   0.005018356];
nga2.M66rvLo50 = [0.033119304, 0.034025707, 0.037341911, 0.047530169,...
		   0.059827313, 0.067125841, 0.074010372, 0.071772064,...
		   0.066391977, 0.061241183, 0.050794904, 0.042260195,...
		   0.028380811, 0.020347486, 0.01244476, 0.00852593,...
		   0.005104347, 0.003121034, 0.00198524, 0.000865789,...
		   0.000471632];
nga2.M66rvHi50 = [0.072425493, 0.073914951, 0.085211981, 0.110196595,...
		   0.131902644, 0.140616093, 0.154042892, 0.149485142,...
		   0.138869765, 0.127465499, 0.105722937, 0.087959058,...
		   0.059070939, 0.042350627, 0.025902137, 0.017745606,...
		   0.010624029, 0.007978404, 0.006734335, 0.004488779,...
		   0.002598649];
nga2.labels = {'ASK14','BSSA14','CB14','CY14','Mean of 4 NGA Models','Acceptance Criteria'};
nga2.acptThin = [4, 5, 7.5, 10];

% Find column numbers corresponding to T
ind1 = zeros(1,size(NGAnum,2));
ind2 = zeros(1,size(Sims,2));
for j=1:length(T);
    Tt = T(j);
    indT1 = NGAnum(1,:)==Tt;
    indT2 = Sims(1,:)==Tt;
    ind1 = ind1 + indT1;
    ind2 = ind2 + indT2;
end

colsNGAT = logical(ind1);
colsSimT = logical(ind2);


%% Build the four NGA matrices

NGAT = NGAnum(1,colsNGAT);
NGAName = NGAnum(:,1);
NGAModel1 = NGAnum(NGAName==1,colsNGAT);
NGAModel2 = NGAnum(NGAName==2,colsNGAT);
NGAModel3 = NGAnum(NGAName==3,colsNGAT);
NGAModel4 = NGAnum(NGAName==4,colsNGAT);

%% Build the Simulation results matrices: 
% X is Period, Y is RotD050. get mean and Std.

X = Sims(1,colsSimT);
Y = Sims(2:end,colsSimT);

meanY = exp(mean(log(Y)));
stdY = std(Y)/sqrt(length(Y));

%% Colors
RGB_xls=[[0.58039  0.54118  0.32941];...  %9 line colors in 'excel' colormap
    [0.96863  0.58824  0.27451];...
    [0.29412  0.67451  0.77647];...
    [0.50196  0.39216  0.77647];...
    [ 0.60784  0.73333  0.34902];...
    [0.75294  0.31373  0.30196];...
    [0.30980  0.50588  0.74118];...
    [0.12157  0.28627  0.49020];...
    [0.45  0.45  0.45]];

%% Set up plot info

    if strcmp('gp',Method);
        MethodName = 'Graves & Pitarka';
    elseif strcmp('sdsu',Method);
        MethodName = 'SDSU';
    elseif strcmp('ucsb',Method);
        MethodName = 'UCSB';
    elseif strcmp('exsim',Method);
        MethodName = 'ExSIM';
    elseif strcmp('csm',Method);
        MethodName = 'CSM';
    elseif strcmp('irikura',Method);
        MethodName = 'Irikura';
    elseif strcmp('song',Method);
        MethodName = 'Song';
    end

    meansim = meanY;
    stdsim = stdY;
    Ysim = Y;
    boxposition = X';
    boxwidth = sortrows(1.5*10.^(log10(X')-1)); %for 'traditional' plotstyle
    
    YNGA1 = exp(mean(log(NGAModel1)));
    YNGA2 = exp(mean(log(NGAModel2)));
    YNGA3 = exp(mean(log(NGAModel3)));
    YNGA4 = exp(mean(log(NGAModel4)));
    NGAMedians = [YNGA1;YNGA2;YNGA3;YNGA4];
    
    NGAAve = exp(mean(log(NGAMedians)));
    
    for i=1:length(NGAT);
    if NGAT(i) <= 0.02
        NGAStdln(i) = 0.24;
    elseif NGAT(i) <=2
        NGAStdln(i) = 0.08*log10(NGAT(i))+0.376;
    else
        NGAStdln(i) = 0.4;
    end
    end
    
    UB = exp(log(NGAAve)+NGAStdln);
    LB = exp(log(NGAAve)-NGAStdln);    
    
    color1 = RGB_xls(2,:);
    color2 = RGB_xls(4,:);
    color3 = RGB_xls(5,:);
    color4 = RGB_xls(6,:);
    colorNGA = [0 0 0];
    
    FS = 14;

%% Select which model to use
if strcmp('nga-west1', Model)
    nga = nga1;
elseif strcmp('nga-west2', Model)
    nga = nga2;
end

%% Figure out which acceptance rules to use
if strcmp('SS', Mech) && Mag == 6.2 && Dist == 20
    acpt_lo = nga.M62ssLo20;
    acpt_hi = nga.M62ssHi20;
    acpt_x = Tacpt;
elseif strcmp('SS', Mech) && Mag == 6.2 && Dist == 50
    acpt_lo = nga.M62ssLo50;
    acpt_hi = nga.M62ssHi50;
    acpt_x = Tacpt;
elseif strcmp('SS', Mech) && Mag == 6.6 && Dist == 20
    acpt_lo = nga.M66ssLo20;
    acpt_hi = nga.M66ssHi20;
    acpt_x = Tacpt;
elseif strcmp('SS', Mech) && Mag == 6.6 && Dist == 50
    acpt_lo = nga.M66ssLo50;
    acpt_hi = nga.M66ssHi50;
    acpt_x = Tacpt;
elseif strcmp('REV', Mech) && Mag == 6.6 && Dist == 20
    acpt_lo = nga.M66rvLo20;
    acpt_hi = nga.M66rvHi20;
    acpt_x = Tacpt;
elseif strcmp('REV', Mech) && Mag == 6.6 && Dist == 50
    acpt_lo = nga.M66rvLo50;
    acpt_hi = nga.M66rvHi50;
    acpt_x = Tacpt;
elseif strcmp('REV', Mech) && Mag == 5.5 && Dist == 20
    acpt_lo = nga.M55rvLo20;
    acpt_hi = nga.M55rvHi20;
    acpt_x = Tacpt;
elseif strcmp('REV', Mech) && Mag == 5.5 && Dist == 50
    acpt_lo = nga.M55rvLo50;
    acpt_hi = nga.M55rvHi50;
    acpt_x = Tacpt;
else
    acpt_lo = LB;
    acpt_hi = UB;
    acpt_x = NGAT;
end

%% Make sure arrays have the same size


acpt_lo = acpt_lo(1:size(acpt_x,2));
acpt_hi = acpt_hi(1:size(acpt_x,2));

%% Plot All NGA relation, mean, range, and boxplot for simulation results.
    
    figure1=figure;
    
    ll(1) = plot(NGAT,YNGA1,'linewidth',1.8,'color',color1); hold all
    ll(2) = plot(NGAT,YNGA2,'linewidth',1.8,'color',color2);
    ll(3) = plot(NGAT,YNGA3,'linewidth',1.8,'color',color3);
    ll(4) = plot(NGAT,YNGA4,'linewidth',1.8,'color',color4);
    ll(5) = plot(NGAT, NGAAve,'linewidth',2,'color',colorNGA);
    ll(6) = plot(acpt_x,acpt_hi(1:size(acpt_x,2)),'--','linewidth',2,'color',colorNGA);
    plot(acpt_x,acpt_lo(1:size(acpt_x,2)),'--','linewidth',2,'color',colorNGA);
    if size(nga.acptThin,2) > 0
        plot(nga.acptThin,acpt_hi(size(acpt_hi,2)-size(nga.acptThin,2)+1:size(acpt_hi,2)),':','linewidth',2,'color',colorNGA);
        plot(nga.acptThin,acpt_lo(size(acpt_lo,2)-size(nga.acptThin,2)+1:size(acpt_lo,2)),':','linewidth',2,'color',colorNGA);
    end
    h=boxplot(Ysim,'positions',boxposition,'widths',boxwidth,'whisker',6);
    hm=findobj('Tag','Median');
    hb=findobj('Tag','Box');
    ho=findobj('Tag','Outliers');
    hw=findobj('Tag','Upper Whisker','-or','Tag','Lower Whisker');
    set(hb,'LineStyle','-','LineWidth',1.5);
    set(hw,'LineStyle','-','LineWidth',1.1);
    set(hm,'Visible','off');
    set(ho,'Visible','off');
    scatter(X,meansim,50,'r','s','filled'); %plot medians again to make larger
    
    legend(ll,nga.labels,'FontSize',FS,'location','SouthWest'); 

    set(gca,'YScale','log','YMinorTick','on',...
    'YMinorGrid','on',...
    'XTickLabel',{'0.01','0.1','1','10'},...
    'XTick',[0.01 0.1 1 10],...
    'XScale','log',...
    'XMinorTick','on',...
    'XMinorGrid','on',...
    'FontSize',14);
    xlim([0.01,20]);ylim([ymin ymax]); box on; grid on;

        % Create xlabel
    xlabel('Period (sec)','Units','points','FontSize',FS);

    % Create ylabel
    ylabel('Sa (g)','FontSize',FS);

    % Create title
    title([ MethodName ', Scenario: M' num2str(Mag) ', ' Mech ', R=' num2str(Dist) ' km, ' Vel],'FontWeight','bold',...
    'FontSize',FS);

    %pause
    Plot_title = [ OUTFile '_w_gmpe.pdf'];
    print(figure1,'-dpdf', '-painters', '-r600', Plot_title)
    close

%% Plot only NGA mean and range overlain by boxplot for simulations.
    
    figure2=figure;
    
    dd(1) = plot(NGAT,NGAAve,'linewidth',2,'color',colorNGA); hold all
    dd(2) = plot(acpt_x,acpt_hi,'--','linewidth',2,'color',colorNGA);
    plot(acpt_x,acpt_lo,'--','linewidth',2,'color',colorNGA);
    h=boxplot(Ysim,'positions',boxposition,'widths',boxwidth,'whisker',6);
    hm=findobj('Tag','Median');
    hb=findobj('Tag','Box');
    ho=findobj('Tag','Outliers');
    hw=findobj('Tag','Upper Whisker','-or','Tag','Lower Whisker');
    set(hb,'LineStyle','-','LineWidth',1.5);
    set(hw,'LineStyle','-','LineWidth',1.1);
    set(hm,'Visible','off');
    set(ho,'Visible','off');
    scatter(X,meansim,50,'r','s','filled'); %plot medians again to make larger
    
    legend(dd,'Mean of 4 NGA Models','Acceptance Criteria',...
        'FontSize',FS,'location','SouthWest'); 

    set(gca,'YScale','log','YMinorTick','on',...
    'YMinorGrid','on',...
    'XTickLabel',{'0.01','0.1','1','10'},...
    'XTick',[0.01 0.1 1 10],...
    'XScale','log',...
    'XMinorTick','on',...
    'XMinorGrid','on',...
    'FontSize',14);
    xlim([0.01,20]);ylim([ymin ymax]); box on; grid on;

        % Create xlabel
    xlabel('Period (sec)','Units','points','FontSize',FS);

    % Create ylabel
    ylabel('Sa (g)','FontSize',FS);

    % Create title
    title([ MethodName ', Scenario: M' num2str(Mag) ', ' Mech ', R=' num2str(Dist) ' km, ' Vel],'FontWeight','bold',...
    'FontSize',FS);

    %pause
    Plot_title = [ OUTFile '.pdf'];
    print(figure2,'-dpdf', '-painters', '-r600', Plot_title)
    close
    

exit
